version: 2.1

jobs:
  check_chip:
    parameters:
      tag:
        type: string
        description: "Runner tag (macos1, macos2, macos3, macos4)"
      target_chip:
        type: string
        description: "The Apple chip to check for (M1 | M2 | M3 | M4)"
    machine: true
    resource_class: exo/hardware
    tags:
      - << parameters.tag >>
    steps:
      - checkout
      - run:
          name: Check Chip and Perform Actions
          command: |
            set -x  # Enable debug mode

            # Retrieve system information
            HOSTNAME=$(hostname)
            IPADDR=$(ifconfig | grep 'inet ' | grep -v 127.0.0.1 | awk '{print $2}')
            CHIP=$(sysctl -n machdep.cpu.brand_string | grep -o "M[1-4]" || echo "Unknown")
            
            # Display machine details
            echo "=== Machine Details ===="
            echo "Hostname: $HOSTNAME"
            echo "IP Address: $IPADDR"
            echo "Chip: $CHIP"
            echo "========================"

            # Check if the machine has the target chip
            if [[ "$CHIP" == "<< parameters.target_chip >>" ]]; then
              echo "‚úÖ Runner has the << parameters.target_chip >> chip."
              
              # Perform environment setup and execute exo
              echo "üîÑ Performing environment setup..."
              sh install.sh
              echo "üöÄ Executing exo..."
              exo 
              echo "‚úÖ Exo executed successfully."
            else
              echo "‚ùå Runner does not have the << parameters.target_chip >> chip. No changes."
              
workflows:
  benchmark:
    jobs:
      - check_chip:
          name: "Check Chip M1"
          tag: "hardware-runner-macbook.local"
          target_chip: "M1"
      - check_chip:
          name: "Check Chip M2"
          tag: "macos2"
          target_chip: "M2"
      - check_chip:
          name: "Check Chip M3"
          tag: "macos3"
          target_chip: "M3"
      - check_chip:
          name: "Check Chip M4"
          tag: "macos4"
          target_chip: "M4"
